trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    displayName: Build and Publish
    steps:
    - task: Maven@3
      displayName: Build Spring Boot Application
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'

    - task: Docker@2
      displayName: Build Docker Image
      inputs:
        command: 'login'
        containerRegistry: 'Connect to demo container registry'

    - task: Docker@2
      displayName: Push Docker Image to ACR
      inputs:
        containerRegistry: 'Connect to demo container registry'
        repository: 'sudhaacrrepo.azurecr.io'
        command: 'buildAndPush'
        Dockerfile: '**/Dockerfile'
    - task: Docker@2
      displayName: Push Docker Image to ACR
      inputs:
        command: push
        tags: |
          sudhaacrrepo.azurecr.io/javaapp:latest

- stage: Deploy
  displayName: Deploy to Azure Container Apps
  jobs:
  - job: Deploy
    displayName: Deploy Application
    steps:
    - task: AzureCLI@2
      displayName: Azure CLI Login
      inputs:
        azureSubscription: 'AzureDevopsConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logged into Azure using Service Connection"

    - task: AzureCLI@2
      displayName: Deploy to Azure Container Apps
      inputs:
        azureSubscription: 'AzureDevopsConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az containerapp create \
            --name $(imageName) \
            --resource-group sudhaResourceGroup \
            --environment managedEnvironment-sudhaResourceGr-9f68 \
            --image sudhaacrrepo/sudhaacrrepo.azurecr.io:54 \
            --target-port 8080 \
            --ingress external \
            --cpu 0.5 \
            --memory 1Gi \
            --min-replicas 1 \
            --max-replicas 5
